<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªÜ TH·ªêNG ƒêI·ªÄU KHI·ªÇN & GI√ÅM S√ÅT T·ª¶ B∆†M T∆Ø·ªöI TI√äU</title>
  <style>
    :root {
      --bg-body: #0f172a;       /* Slate 900 */
      --bg-card: #1e293b;       /* Slate 800 */
      --text-main: #f1f5f9;     /* Slate 100 */
      --text-muted: #94a3b8;    /* Slate 400 */
      --primary: #3b82f6;       /* Blue 500 */
      --primary-hover: #2563eb; /* Blue 600 */
      --success: #10b981;       /* Emerald 500 */
      --danger: #ef4444;        /* Red 500 */
      --border: #334155;        /* Slate 700 */
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      /* Subtle gradient background */
      background-image: radial-gradient(circle at top right, rgba(59, 130, 246, 0.15), transparent 40%),
                        radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.1), transparent 40%);
      background-attachment: fixed;
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(to right, #fff, #cbd5e1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 2rem;
      gap: 0.5rem;
    }

    .clock-wrapper {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      font-variant-numeric: tabular-nums;
    }
    .date { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    .clock { font-size: 1.25rem; font-weight: 600; color: var(--primary); }

    .btn-sync {
      background: rgba(59, 130, 246, 0.1);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.2);
      padding: 0.4rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      transition: all 0.2s;
    }
    .btn-sync:hover { background: rgba(59, 130, 246, 0.2); transform: translateY(-1px); }
    .btn-sync svg { width: 14px; height: 14px; fill: currentColor; }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1.5rem;
      width: 100%;
      max-width: 1100px;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .card h3 {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 1rem;
    }
    .card h3 svg { fill: var(--primary); width: 18px; height: 18px; }

    /* Mode Switch */
    .mode-switch {
      width: 100%;
      padding: 1rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--text-main);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .mode-switch:hover { background: rgba(255,255,255,0.05); }
    .mode-switch.auto {
      background: rgba(59, 130, 246, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Status Text */
    .status-box {
      padding: 0.75rem 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 0.5rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-muted);
    }
    .status-dot {
      width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%;
      transition: background 0.3s;
    }
    .status-dot.active {
      background: var(--success);
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
      animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    /* Pump Controls */
    .pump-group-title {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      margin: 1.5rem 0 0.75rem 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .pump-group-title:first-child { margin-top: 0; }

    .pump-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.02);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      border: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .pump-item:hover { border-color: var(--border); }

    .pump-info { display: flex; align-items: center; gap: 0.75rem; }
    .status-led {
      width: 8px; height: 8px; border-radius: 50%;
      background-color: #334155;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.05);
      transition: all 0.3s;
    }
    .status-led.on { background-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .status-led.off { background-color: var(--danger); }

    .pump-name { font-weight: 500; font-size: 0.95rem; }

    .btn-group { display: flex; gap: 0.25rem; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 0.5rem; }
    .btn-ctrl {
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 0.4rem 0.8rem;
      border-radius: 0.3rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-ctrl:hover { color: #fff; }
    .btn-ctrl.active-on { background: var(--success); color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .btn-ctrl.active-off { background: var(--danger); color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    /* Inputs */
    .config-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .config-row:last-child { border-bottom: none; }
    .config-label { font-size: 0.9rem; color: var(--text-muted); }
    
    .time-input {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: rgba(0,0,0,0.2);
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      border: 1px solid var(--border);
    }
    .time-input input {
      background: transparent;
      border: none;
      color: #fff;
      width: 2.5rem;
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
    }
    .time-input input:focus { outline: none; }
    
    /* Save Button */
    .save-btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 1rem;
    }
    .save-btn:hover { background: var(--primary-hover); }

    .hidden { display: none; }
    
    /* Toast Notification */
    #toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #334155;
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      font-weight: 500;
    }
    #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    #toast.success { background: var(--success); }
    #toast.error { background: var(--danger); }
  </style>
</head>
<body>
  <h1>Do√£n Qu·∫£ng IoT</h1>
  
  <div class="header-meta">
    <div class="clock-wrapper">
      <div id="date" class="date">--/--/----</div>
      <div id="clock" class="clock">--:--:--</div>
    </div>
    <button class="btn-sync" onclick="syncTime()">
      <svg viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8zm0-14c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6 2.69-6 6-6zm-1 2v5l4.2 2.5.75-1.23-3.45-2.05V8h-1.5z"/></svg>
      ƒê·ªìng b·ªô th·ªùi gian
    </button>
  </div>

  <div class="container">
    <!-- STATUS CARD -->
    <div class="card">
      <!-- Connection Panel for External Hosting -->
      <div id="connection-panel" class="hidden" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input type="text" id="device-ip-input" placeholder="Nh·∫≠p IP ESP32 (vd: 192.168.1.10)" style="flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: white; padding: 0.5rem; border-radius: 0.5rem;">
          <button onclick="saveIp()" style="background: var(--primary); color: white; border: none; padding: 0 1rem; border-radius: 0.5rem; cursor: pointer;">L∆∞u</button>
        </div>
        <div style="font-size: 0.75rem; color: var(--danger);">L∆∞u √Ω: N·∫øu d√πng GitHub Pages (HTTPS), b·∫°n c√≥ th·ªÉ c·∫ßn cho ph√©p "Insecure Content" ƒë·ªÉ k·∫øt n·ªëi t·ªõi IP (HTTP).</div>
      </div>

      <h3><svg viewBox="0 0 24 24"><path d="M13 3h-2v10h2V3zm4.83 2.17l-1.42 1.42C17.99 7.86 19 9.81 19 12c0 3.87-3.13 7-7 7s-7-3.13-7-7c0-2.19 1.01-4.14 2.58-5.42L6.17 5.17C4.23 6.82 3 9.26 3 12c0 4.97 4.03 9 9 9s9-4.03 9-9c0-2.74-1.23-5.18-3.17-6.83z"/></svg> TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG</h3>
      
      <button id="btn-mode-toggle" class="mode-switch" onclick="toggleMode()">
        <span id="mode-icon">‚öôÔ∏è</span>
        <span id="mode-text">CH·∫æ ƒê·ªò: TH·ª¶ C√îNG</span>
      </button>

      <div class="status-box">
        <div id="status-dot" class="status-dot"></div>
        <span id="status-text">ƒêang k·∫øt n·ªëi...</span>
        <span id="countdown" style="margin-left: auto; color: var(--primary); font-family: monospace; font-weight: 600;"></span>
        <span id="temp-text" style="margin-left: 10px; font-weight: 600; color: var(--text-main);"></span>
      </div>
    </div>

    <!-- MANUAL PANEL -->
    <div id="manual-panel" class="card">
      <h3><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg> B·∫¢NG ƒêI·ªÄU KHI·ªÇN</h3>
      
      <!-- SLAVE 1 -->
      <div class="pump-group-title">Khu V·ª±c 1 (Slave 1)</div>
      <div class="pump-item"><div class="pump-info"><div id="led-s1-p1" class="status-led off"></div><span class="pump-name">Van 1</span></div><div class="btn-group"><button id="btn-s1-p1-on" class="btn-ctrl" onclick="ctrl(1,1,1)">ON</button><button id="btn-s1-p1-off" class="btn-ctrl" onclick="ctrl(1,1,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s1-p2" class="status-led off"></div><span class="pump-name">Van 2</span></div><div class="btn-group"><button id="btn-s1-p2-on" class="btn-ctrl" onclick="ctrl(1,2,1)">ON</button><button id="btn-s1-p2-off" class="btn-ctrl" onclick="ctrl(1,2,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s1-p3" class="status-led off"></div><span class="pump-name">Van 3</span></div><div class="btn-group"><button id="btn-s1-p3-on" class="btn-ctrl" onclick="ctrl(1,3,1)">ON</button><button id="btn-s1-p3-off" class="btn-ctrl" onclick="ctrl(1,3,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s1-p4" class="status-led off"></div><span class="pump-name">Van 4</span></div><div class="btn-group"><button id="btn-s1-p4-on" class="btn-ctrl" onclick="ctrl(1,4,1)">ON</button><button id="btn-s1-p4-off" class="btn-ctrl" onclick="ctrl(1,4,0)">OFF</button></div></div>

      <!-- SLAVE 2 -->
      <div class="pump-group-title">Khu V·ª±c 2 (Slave 2)</div>
      <div class="pump-item"><div class="pump-info"><div id="led-s2-p1" class="status-led off"></div><span class="pump-name">Van 1</span></div><div class="btn-group"><button id="btn-s2-p1-on" class="btn-ctrl" onclick="ctrl(2,1,1)">ON</button><button id="btn-s2-p1-off" class="btn-ctrl" onclick="ctrl(2,1,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s2-p2" class="status-led off"></div><span class="pump-name">Van 2</span></div><div class="btn-group"><button id="btn-s2-p2-on" class="btn-ctrl" onclick="ctrl(2,2,1)">ON</button><button id="btn-s2-p2-off" class="btn-ctrl" onclick="ctrl(2,2,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s2-p3" class="status-led off"></div><span class="pump-name">Van 3</span></div><div class="btn-group"><button id="btn-s2-p3-on" class="btn-ctrl" onclick="ctrl(2,3,1)">ON</button><button id="btn-s2-p3-off" class="btn-ctrl" onclick="ctrl(2,3,0)">OFF</button></div></div>
      <div class="pump-item"><div class="pump-info"><div id="led-s2-p4" class="status-led off"></div><span class="pump-name">Van 4</span></div><div class="btn-group"><button id="btn-s2-p4-on" class="btn-ctrl" onclick="ctrl(2,4,1)">ON</button><button id="btn-s2-p4-off" class="btn-ctrl" onclick="ctrl(2,4,0)">OFF</button></div></div>

      <!-- MASTER -->
      <div class="pump-group-title">B∆°m T·ªïng (Master)</div>
      <div class="pump-item" style="background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.2);">
        <div class="pump-info">
          <div id="led-master" class="status-led off"></div>
          <span class="pump-name" style="color: var(--primary);">B∆°m Ch√≠nh</span>
        </div>
        <div class="btn-group">
          <button id="btn-master-on" class="btn-ctrl" onclick="ctrlMaster(1)">ON</button>
          <button id="btn-master-off" class="btn-ctrl" onclick="ctrlMaster(0)">OFF</button>
        </div>
      </div>
    </div>

    <!-- AUTO PANEL -->
    <div id="auto-panel" class="card hidden">
      <h3><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> C·∫§U H√åNH T·ª∞ ƒê·ªòNG</h3>
      <p style="color: var(--text-muted); font-size:0.85rem; margin-bottom:1.5rem; line-height: 1.5;">
        Chu tr√¨nh: Slave (20s) ‚ûî Master (30p)
      </p>
      
      <div class="config-row">
        <span class="config-label">Gi·ªù ch·∫°y S√°ng</span>
        <div class="time-input">
          <input type="number" id="mh" min="0" max="23" placeholder="HH">
          <span>:</span>
          <input type="number" id="mm" min="0" max="59" placeholder="MM">
        </div>
      </div>
      
      <div class="config-row">
        <span class="config-label">Gi·ªù ch·∫°y Chi·ªÅu</span>
        <div class="time-input">
          <input type="number" id="eh" min="0" max="23" placeholder="HH">
          <span>:</span>
          <input type="number" id="em" min="0" max="59" placeholder="MM">
        </div>
      </div>
      
      <div class="config-row">
        <span class="config-label">Th·ªùi gian B∆°m Master</span>
        <div class="time-input">
          <input type="number" id="mt" min="1" max="120">
          <span style="font-size: 0.8rem; color: var(--text-muted);">Ph√∫t</span>
        </div>
      </div>

      <button class="save-btn" onclick="saveConfig()">L∆ØU C√ÄI ƒê·∫∂T</button>
    </div>
  </div>

  <div id="toast">ƒê√£ l∆∞u c√†i ƒë·∫∑t!</div>

  <script>
    let currentMode = 0;
    let deviceIp = localStorage.getItem('esp32_ip');

    // Ki·ªÉm tra xem ƒëang ch·∫°y tr√™n t√™n mi·ªÅn (GitHub) hay IP tr·ª±c ti·∫øp
    // N·∫øu kh√¥ng ph·∫£i l√† IP (vd: github.io), hi·ªán b·∫£ng nh·∫≠p IP
    if (window.location.hostname !== '' && !window.location.hostname.match(/^(\d{1,3}\.){3}\d{1,3}$/) && window.location.hostname !== 'esp32.local') {
      document.getElementById('connection-panel').classList.remove('hidden');
      if(deviceIp) document.getElementById('device-ip-input').value = deviceIp;
    }

    function saveIp() {
      const ip = document.getElementById('device-ip-input').value;
      if(ip) {
        localStorage.setItem('esp32_ip', ip);
        deviceIp = ip;
        showToast("ƒê√£ l∆∞u IP: " + ip);
        fetchStatus();
      }
    }

    function getApiUrl(path) {
      if (deviceIp && (window.location.hostname === '' || !window.location.hostname.match(/^(\d{1,3}\.){3}\d{1,3}$/))) {
        return `http://${deviceIp}${path}`;
      }
      return path;
    }

    function showToast(msg, type = 'success') {
      const x = document.getElementById("toast");
      x.innerText = msg;
      x.className = "show " + type;
      setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    function updateUI(data) {
      currentMode = data.mode;
      document.getElementById('clock').innerText = data.time;
      document.getElementById('status-text').innerText = data.status;
      
      document.getElementById('status-dot').className = "status-dot " + (data.status === "ƒê√£ k·∫øt n·ªëi" ? "active" : "");

      // Hi·ªÉn th·ªã ƒë·∫øm ng∆∞·ª£c
      if (data.remain !== undefined && data.remain > 0) {
        let m = Math.floor(data.remain / 60);
        let s = data.remain % 60;
        document.getElementById('countdown').innerText = `[${m}:${s.toString().padStart(2, '0')}]`;
      } else {
        document.getElementById('countdown').innerText = "";
      }

      if (data.temp) {
        document.getElementById('temp-text').innerText = data.temp.toFixed(1) + "¬∞C";
      }
      const modeBtn = document.getElementById('btn-mode-toggle');
      
      if(data.mode == 1) {
        document.getElementById('mode-text').innerText = "ƒêANG CH·∫†Y T·ª∞ ƒê·ªòNG";
        document.getElementById('mode-icon').innerText = "ü§ñ";
        modeBtn.classList.add('auto');
        
        // Hi·ªÉn th·ªã panel ƒëi·ªÅu khi·ªÉn nh∆∞ng v√¥ hi·ªáu h√≥a thao t√°c (ch·ªâ ƒë·ªÉ xem tr·∫°ng th√°i)
        const manualPanel = document.getElementById('manual-panel');
        manualPanel.classList.remove('hidden');
        manualPanel.style.pointerEvents = 'none'; // Kh√¥ng cho b·∫•m
        manualPanel.style.opacity = '0.6'; // L√†m m·ªù nh·∫π
        document.querySelector('#manual-panel h3').lastChild.textContent = " GI√ÅM S√ÅT HO·∫†T ƒê·ªòNG";

        document.getElementById('auto-panel').classList.remove('hidden');
      } else {
        document.getElementById('mode-text').innerText = "CH·∫æ ƒê·ªò: TH·ª¶ C√îNG";
        document.getElementById('mode-icon').innerText = "üñêÔ∏è";
        modeBtn.classList.remove('auto');
        
        const manualPanel = document.getElementById('manual-panel');
        manualPanel.classList.remove('hidden');
        manualPanel.style.pointerEvents = 'auto'; // Cho ph√©p b·∫•m
        manualPanel.style.opacity = '1';
        document.querySelector('#manual-panel h3').lastChild.textContent = " B·∫¢NG ƒêI·ªÄU KHI·ªÇN";

        document.getElementById('auto-panel').classList.add('hidden');
      }

      // Update Pump Status
      if (data.slaves) {
        for(let s=0; s<2; s++) {
          for(let p=0; p<4; p++) {
            let isOn = data.slaves[s][p] == 1;
            let btnOn = document.getElementById(`btn-s${s+1}-p${p+1}-on`);
            let btnOff = document.getElementById(`btn-s${s+1}-p${p+1}-off`);
            if(btnOn && btnOff) {
               btnOn.classList.toggle('active-on', isOn);
               btnOff.classList.toggle('active-off', !isOn);
            }
            let led = document.getElementById(`led-s${s+1}-p${p+1}`);
            if(led) {
              led.className = 'status-led ' + (isOn ? 'on' : 'off');
            }
          }
        }
      }
      if (data.master !== undefined) {
         let mOn = document.getElementById('btn-master-on');
         let mOff = document.getElementById('btn-master-off');
         if(mOn && mOff) {
            let isMOn = data.master == 1;
            mOn.classList.toggle('active-on', isMOn);
            mOff.classList.toggle('active-off', !isMOn);
            let ledM = document.getElementById('led-master');
            if(ledM) {
              ledM.className = 'status-led ' + (isMOn ? 'on' : 'off');
            }
         }
      }
      
      // Only update inputs if not focused to avoid jumping values while typing
      if (document.activeElement.tagName !== 'INPUT') {
        document.getElementById('mh').value = data.mh;
        document.getElementById('mm').value = data.mm;
        document.getElementById('eh').value = data.eh;
        document.getElementById('em').value = data.em;
        document.getElementById('mt').value = data.mt;
      }
    }

    function fetchStatus() {
      fetch(getApiUrl('/status'))
        .then(r => r.json())
        .then(data => updateUI(data))
        .catch(e => console.log(e));
    }

    function setMode(m) {
      fetch(getApiUrl('/mode?val=' + m)).then(() => fetchStatus());
    }

    function toggleMode() {
      let newMode = currentMode == 1 ? 0 : 1;
      setMode(newMode);
      let targetMode = currentMode == 1 ? "TH·ª¶ C√îNG" : "T·ª∞ ƒê·ªòNG";
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn sang ch·∫ø ƒë·ªô " + targetMode + " kh√¥ng?")) {
        let newMode = currentMode == 1 ? 0 : 1;
        setMode(newMode);
      }
    }

    function ctrl(slave, pump, state) {
      fetch(getApiUrl(`/control?slave=${slave}&pump=${pump}&state=${state}`));
    }
    
    function ctrlMaster(state) {
      fetch(getApiUrl(`/control_master?state=${state}`));
    }

    function saveConfig() {
      let mh = document.getElementById('mh').value;
      let mm = document.getElementById('mm').value;
      let eh = document.getElementById('eh').value;
      let em = document.getElementById('em').value;
      let mt = document.getElementById('mt').value;
      let url = getApiUrl(`/config?mh=${mh}&mm=${mm}&eh=${eh}&em=${em}&mt=${mt}`);
      fetch(url)
        .then(response => {
          if (response.ok) showToast("ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!", "success");
          else showToast("L·ªói khi l∆∞u!", "error");
        })
        .catch(() => showToast("M·∫•t k·∫øt n·ªëi!", "error"));
    }

    function syncTime() {
      const d = new Date();
      const url = getApiUrl(`/sync_time?y=${d.getFullYear()}&m=${d.getMonth()+1}&d=${d.getDate()}&h=${d.getHours()}&mi=${d.getMinutes()}&s=${d.getSeconds()}`);
      fetch(url)
        .then(r => {
          if(r.ok) showToast("ƒê√£ ƒë·ªìng b·ªô th·ªùi gian!", "success");
          else showToast("L·ªói ƒë·ªìng b·ªô!", "error");
        })
        .catch(() => showToast("L·ªói k·∫øt n·ªëi!", "error"));
    }

    setInterval(fetchStatus, 2000);
    fetchStatus();
  </script>
</body>
</html>
